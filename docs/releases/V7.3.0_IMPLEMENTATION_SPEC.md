# V7.3.0 Implementation Specification
## Hybrid Entry System & Partial Exit Management

**Version:** V7.3.0  
**Date:** January 12, 2026  
**Implementation Strategy:** Incremental batches with testing between each

---

## Overview

Transform SSOF from single-entry/single-exit to a professional-grade position management system with:
- **Dual Entry System:** Momentum (20%) + Pullback (80%) entries
- **3-Tier Exits:** T1 (30%), T2 (40%), T3 (30%) with progressive targets
- **Dynamic R:R:** 1.5R to 5R+ depending on market conditions

---

## BATCH 1: Momentum Entry System

### Objective
Add immediate entry capability on strong BOS confirmation for early position establishment.

### 1.1 Input Settings (Add after line 107)

```pine
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Momentum Entry (Tier 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grpMomentum = "âš¡ Momentum Entry (Tier 1)"
enableMomentumEntry = input.bool(true, "Enable Momentum Entry?", group=grpMomentum, 
    tooltip="Take immediate entry on BOS confirmation (before pullback)\nAllows capturing full impulse move at cost of wider stop")
momentumPositionSize = input.int(20, "Momentum Position Size %", minval=5, maxval=50, group=grpMomentum,
    tooltip="Percentage of full position to enter on momentum\nRecommended: 20% (leaves 80% for pullback entry)")
momentumRequireStrong = input.bool(true, "Require Strong BOS for Momentum?", group=grpMomentum,
    tooltip="Only take momentum entry on Strong (S) BOS\nFilters weak/low-probability setups")
momentumMinDisplacement = input.float(0.7, "Min Displacement (Body/ATR)", minval=0.3, maxval=1.5, step=0.1, group=grpMomentum,
    tooltip="Minimum candle body size for momentum entry\nHigher = more aggressive BOS required\nRecommended: 0.7 for XAG/USD 1H")
showMomentumLabels = input.bool(true, "Show Momentum Entry Labels?", group=grpMomentum,
    tooltip="Display âš¡ ENTRY labels on momentum entries")
```

### 1.2 State Variables (Add to structure section after line 346)

```pine
// V7.3.0: Momentum Entry Tracking
var bool momentumEntryTaken = false        // Has momentum entry been executed?
var int momentumEntryBar = na              // Bar index of momentum entry
var float momentumEntryPrice = na          // Entry price for momentum entry
var float momentumStopLevel = na           // Stop loss for momentum entry
```

### 1.3 Entry Logic (Add in bullishBOS block after line 453)

```pine
// V7.3.0: Momentum Entry Check
if enableMomentumEntry and not momentumEntryTaken
    // Check if criteria met for momentum entry
    momentumCriteriaMet = true
    
    // Filter 1: Strong BOS requirement
    if momentumRequireStrong and not bosIsStrong
        momentumCriteriaMet := false
    
    // Filter 2: Displacement threshold
    if candleBody < (atrValue * momentumMinDisplacement)
        momentumCriteriaMet := false
    
    // Execute momentum entry
    if momentumCriteriaMet
        momentumEntryTaken := true
        momentumEntryBar := bar_index
        momentumEntryPrice := close
        momentumStopLevel := protectedLow  // Stop below protected level
        
        // Set initial exit target (same as pullback system)
        if na(highestSwingInRun) or confirmedSwingHigh > highestSwingInRun
            highestSwingInRun := confirmedSwingHigh
        entrySwingTarget := highestSwingInRun
```

**Bearish equivalent** (add in bearishBOS block after line 498):
- Same logic but use `protectedHigh` for stop
- Use `lowestSwingInRun` for target

### 1.4 Momentum Entry Reset Logic

Add after structure flip or max bars exceeded:

```pine
// Reset momentum entry if conditions invalidate
if momentumEntryTaken and not entryConfirmed
    // Check invalidation conditions
    barsElapsed = bar_index - momentumEntryBar
    
    // Invalidation 1: Structure flip
    if (pullbackDirection == 1 and bearishBOS) or (pullbackDirection == -1 and bullishBOS)
        momentumEntryTaken := false
        momentumEntryBar := na
        momentumEntryPrice := na
    
    // Invalidation 2: Max bars without pullback entry (close momentum position)
    else if barsElapsed > 15
        // Close momentum entry - no pullback occurred
        momentumEntryTaken := false
        momentumEntryBar := na
        momentumEntryPrice := na
```

### 1.5 Visualization (Add in visualization section after line 640)

```pine
// Momentum Entry Label
if showMomentumLabels and momentumEntryTaken and bar_index == momentumEntryBar
    labelColor = pullbackDirection == 1 ? color.rgb(255, 215, 0) : color.rgb(255, 140, 0)
    labelText = "âš¡ ENTRY\n" + str.tostring(momentumPositionSize) + "%"
    labelStyle = pullbackDirection == 1 ? label.style_label_up : label.style_label_down
    labelY = pullbackDirection == 1 ? low - atrValue * 0.2 : high + atrValue * 0.2
    
    label.new(bar_index, labelY, labelText,
              style=labelStyle,
              color=labelColor,
              textcolor=color.white,
              size=size.small)
```

### 1.6 Alert Conditions (Add to alerts section)

```pine
// Momentum Entry Alerts
momentumEntryLong = enableMomentumEntry and pullbackDirection == 1 and momentumEntryTaken and bar_index == momentumEntryBar
momentumEntryShort = enableMomentumEntry and pullbackDirection == -1 and momentumEntryTaken and bar_index == momentumEntryBar

alertcondition(momentumEntryLong, title="Momentum Entry - Long", 
    message="âš¡ Momentum Entry LONG (" + str.tostring(momentumPositionSize) + "%) on {{ticker}} {{interval}}")
alertcondition(momentumEntryShort, title="Momentum Entry - Short",
    message="âš¡ Momentum Entry SHORT (" + str.tostring(momentumPositionSize) + "%) on {{ticker}} {{interval}}")
```

### 1.7 Testing Checklist for Batch 1

- [ ] Strong BOS triggers momentum entry
- [ ] Weak BOS does NOT trigger momentum entry (if filter enabled)
- [ ] Momentum entry label appears on BOS candle
- [ ] Position size shown in label (e.g., "20%")
- [ ] Momentum entry invalidates on structure flip
- [ ] Momentum entry closes after 15 bars if no pullback
- [ ] Alert fires on momentum entry
- [ ] Can be disabled via settings
- [ ] Works for both bullish and bearish BOS

---

## BATCH 2: Partial Exit System

### Objective
Replace single-exit with 3-tier progressive exit management.

### 2.1 Input Settings (Add new group after momentum entry)

```pine
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Partial Exits (Position Management) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grpPartialExits = "ðŸ“Š Partial Exits"
enablePartialExits = input.bool(true, "Enable Partial Exits?", group=grpPartialExits,
    tooltip="Use 3-tier exit strategy instead of single exit\nT1: Quick profit, T2: Main target, T3: Runner")

// T1 Settings
t1PositionPct = input.int(30, "T1 Position %", minval=10, maxval=50, group=grpPartialExits,
    tooltip="Percentage to exit at first target")
t1TargetType = input.string("R:R Ratio", "T1 Target Type", 
    options=["R:R Ratio", "First Swing"], group=grpPartialExits,
    tooltip="R:R Ratio: Fixed multiple of risk\nFirst Swing: Nearest swing high/low")
t1RRRatio = input.float(1.5, "T1 R:R Ratio", minval=1.0, maxval=3.0, step=0.1, group=grpPartialExits,
    tooltip="Risk:Reward ratio for T1 exit")

// T2 Settings  
t2PositionPct = input.int(40, "T2 Position %", minval=20, maxval=60, group=grpPartialExits,
    tooltip="Percentage to exit at second target")
t2TargetType = input.string("BOS Swing", "T2 Target Type",
    options=["R:R Ratio", "BOS Swing"], group=grpPartialExits,
    tooltip="R:R Ratio: Fixed multiple\nBOS Swing: Dynamic structure target")
t2RRRatio = input.float(2.5, "T2 R:R Ratio", minval=1.5, maxval=5.0, step=0.1, group=grpPartialExits,
    tooltip="Risk:Reward ratio for T2 exit")

// T3 Settings
t3PositionPct = input.int(30, "T3 Position %", minval=10, maxval=50, group=grpPartialExits,
    tooltip="Percentage to exit at third target (runner)")
t3UseTrailStop = input.bool(true, "T3 Use Trail Stop?", group=grpPartialExits,
    tooltip="Trail stop below/above swing lows/highs for runner")
t3TrailMethod = input.string("Swing Levels", "T3 Trail Method",
    options=["Swing Levels", "ATR Distance"], group=grpPartialExits,
    tooltip="Swing Levels: Trail below HL/above LH\nATR Distance: Fixed ATR distance")
t3ATRMultiple = input.float(1.5, "T3 ATR Multiple", minval=0.5, maxval=3.0, step=0.1, group=grpPartialExits,
    tooltip="ATR multiple for trail stop if using ATR method")

// Visualization
showTargetLines = input.bool(true, "Show Target Lines?", group=grpPartialExits,
    tooltip="Draw horizontal lines at T1 and T2 targets")
showTrailStopLine = input.bool(true, "Show Trail Stop Line?", group=grpPartialExits,
    tooltip="Draw dynamic trail stop line for T3")
```

### 2.2 State Variables (Add to exit tracking section after line 1262)

```pine
// V7.3.0: Partial Exit Tracking
var bool t1ExitTriggered = false           // T1 target reached
var bool t2ExitTriggered = false           // T2 target reached  
var bool t3ExitTriggered = false           // T3 stopped out
var float t1TargetPrice = na               // T1 price level
var float t2TargetPrice = na               // T2 price level
var float t3TrailStopPrice = na            // Dynamic trail stop
var int remainingPositionPct = 100         // Track position % remaining
var float entryStopDistance = na           // Distance from entry to stop (for R:R calc)

// Target line objects
var line t1TargetLine = na
var line t2TargetLine = na
var line t3TrailLine = na
```

### 2.3 Target Calculation (On entry confirmation)

Add to pullback entry confirmation block (around line 1570):

```pine
// V7.3.0: Calculate partial exit targets
if enablePartialExits
    // Calculate stop distance for R:R calculations
    if pullbackDirection == 1
        entryStopDistance := close - protectedLow
    else
        entryStopDistance := protectedHigh - close
    
    // T1 Target Calculation
    if t1TargetType == "R:R Ratio"
        if pullbackDirection == 1
            t1TargetPrice := close + (entryStopDistance * t1RRRatio)
        else
            t1TargetPrice := close - (entryStopDistance * t1RRRatio)
    else  // First Swing
        // Find nearest swing high/low after entry
        if pullbackDirection == 1
            t1TargetPrice := confirmedSwingHigh
        else
            t1TargetPrice := confirmedSwingLow
    
    // T2 Target Calculation
    if t2TargetType == "R:R Ratio"
        if pullbackDirection == 1
            t2TargetPrice := close + (entryStopDistance * t2RRRatio)
        else
            t2TargetPrice := close - (entryStopDistance * t2RRRatio)
    else  // BOS Swing (dynamic target)
        t2TargetPrice := entrySwingTarget
    
    // T3 Trail Stop Initialization
    if t3UseTrailStop
        if pullbackDirection == 1
            t3TrailStopPrice := protectedLow
        else
            t3TrailStopPrice := protectedHigh
    
    // Reset exit flags
    t1ExitTriggered := false
    t2ExitTriggered := false
    t3ExitTriggered := false
    remainingPositionPct := 100
```

### 2.4 Exit Logic (Replace current exit system)

Replace the single exit logic (lines 1597-1693) with:

```pine
// V7.3.0: Partial Exit System
if enablePartialExits and entryConfirmed and remainingPositionPct > 0
    
    // T1 Exit Check (30% position)
    if not t1ExitTriggered and not na(t1TargetPrice)
        t1Reached = false
        if pullbackDirection == 1 and high >= t1TargetPrice
            t1Reached := true
        else if pullbackDirection == -1 and low <= t1TargetPrice
            t1Reached := true
        
        if t1Reached
            t1ExitTriggered := true
            remainingPositionPct -= t1PositionPct
            
            // T1 Exit Label
            exitColor = color.rgb(0, 200, 83)  // Green for profit
            exitY = pullbackDirection == 1 ? high + atrValue * 0.3 : low - atrValue * 0.3
            label.new(bar_index, exitY, 
                (pullbackDirection == 1 ? "â–¼" : "â–²") + " EXIT T1\n" + str.tostring(t1PositionPct) + "%",
                style=pullbackDirection == 1 ? label.style_label_down : label.style_label_up,
                color=exitColor,
                textcolor=color.white,
                size=size.normal)
    
    // T2 Exit Check (40% position)
    else if t1ExitTriggered and not t2ExitTriggered and not na(t2TargetPrice)
        t2Reached = false
        if pullbackDirection == 1 and high >= t2TargetPrice
            t2Reached := true
        else if pullbackDirection == -1 and low <= t2TargetPrice
            t2Reached := true
        
        if t2Reached
            t2ExitTriggered := true
            remainingPositionPct -= t2PositionPct
            
            // T2 Exit Label
            exitColor = color.rgb(0, 200, 83)
            exitY = pullbackDirection == 1 ? high + atrValue * 0.3 : low - atrValue * 0.3
            label.new(bar_index, exitY,
                (pullbackDirection == 1 ? "â–¼" : "â–²") + " EXIT T2\n" + str.tostring(t2PositionPct) + "%",
                style=pullbackDirection == 1 ? label.style_label_down : label.style_label_up,
                color=exitColor,
                textcolor=color.white,
                size=size.normal)
    
    // T3 Exit Check (30% position - runner with trail stop)
    else if t2ExitTriggered and not t3ExitTriggered
        // Update trail stop
        if t3UseTrailStop
            if t3TrailMethod == "Swing Levels"
                // Trail stop at swing levels
                if pullbackDirection == 1 and not na(swingLow)
                    // Trail up below new Higher Lows
                    if swingLow > t3TrailStopPrice
                        t3TrailStopPrice := swingLow
                else if pullbackDirection == -1 and not na(swingHigh)
                    // Trail down above new Lower Highs
                    if swingHigh < t3TrailStopPrice
                        t3TrailStopPrice := swingHigh
            else  // ATR Distance method
                if pullbackDirection == 1
                    t3TrailStopPrice := math.max(t3TrailStopPrice, high - (atrValue * t3ATRMultiple))
                else
                    t3TrailStopPrice := math.min(t3TrailStopPrice, low + (atrValue * t3ATRMultiple))
        
        // Check if trail stop hit
        t3StopHit = false
        if pullbackDirection == 1 and close < t3TrailStopPrice
            t3StopHit := true
        else if pullbackDirection == -1 and close > t3TrailStopPrice
            t3StopHit := true
        
        // Check for structure flip (also exits T3)
        if (pullbackDirection == 1 and bearishBOS) or (pullbackDirection == -1 and bullishBOS)
            t3StopHit := true
        
        if t3StopHit
            t3ExitTriggered := true
            remainingPositionPct -= t3PositionPct
            
            // T3 Exit Label
            exitColor = color.orange
            exitY = pullbackDirection == 1 ? low - atrValue * 0.3 : high + atrValue * 0.3
            label.new(bar_index, exitY,
                (pullbackDirection == 1 ? "â–¼" : "â–²") + " EXIT T3\n" + str.tostring(t3PositionPct) + "%",
                style=pullbackDirection == 1 ? label.style_label_down : label.style_label_up,
                color=exitColor,
                textcolor=color.white,
                size=size.normal)
```

### 2.5 Target Line Visualization

Add after partial exit logic:

```pine
// Draw/update target lines
if enablePartialExits and showTargetLines and entryConfirmed
    lineColor = pullbackDirection == 1 ? bullColor : bearColor
    
    // T1 Target Line
    if not t1ExitTriggered and not na(t1TargetPrice)
        if na(t1TargetLine)
            t1TargetLine := line.new(bar_index, t1TargetPrice, bar_index + 10, t1TargetPrice,
                color=color.new(lineColor, 60), width=1, style=line.style_dashed)
        else
            line.set_x2(t1TargetLine, bar_index + 10)
            line.set_y1(t1TargetLine, t1TargetPrice)
            line.set_y2(t1TargetLine, t1TargetPrice)
    else if not na(t1TargetLine)
        line.delete(t1TargetLine)
        t1TargetLine := na
    
    // T2 Target Line
    if t1ExitTriggered and not t2ExitTriggered and not na(t2TargetPrice)
        if na(t2TargetLine)
            t2TargetLine := line.new(bar_index, t2TargetPrice, bar_index + 10, t2TargetPrice,
                color=color.new(lineColor, 60), width=1, style=line.style_dashed)
        else
            line.set_x2(t2TargetLine, bar_index + 10)
            line.set_y1(t2TargetLine, t2TargetPrice)
            line.set_y2(t2TargetLine, t2TargetPrice)
    else if not na(t2TargetLine)
        line.delete(t2TargetLine)
        t2TargetLine := na
    
    // T3 Trail Stop Line
    if showTrailStopLine and t2ExitTriggered and not t3ExitTriggered and not na(t3TrailStopPrice)
        trailColor = pullbackDirection == 1 ? bearColor : bullColor
        if na(t3TrailLine)
            t3TrailLine := line.new(bar_index, t3TrailStopPrice, bar_index + 10, t3TrailStopPrice,
                color=color.new(trailColor, 50), width=2, style=line.style_solid)
        else
            line.set_x2(t3TrailLine, bar_index + 10)
            line.set_y1(t3TrailLine, t3TrailStopPrice)
            line.set_y2(t3TrailLine, t3TrailStopPrice)
    else if not na(t3TrailLine)
        line.delete(t3TrailLine)
        t3TrailLine := na
```

### 2.6 Alert Conditions

```pine
// Partial Exit Alerts
exitT1Long = enablePartialExits and pullbackDirection == 1 and t1ExitTriggered
exitT1Short = enablePartialExits and pullbackDirection == -1 and t1ExitTriggered
exitT2Long = enablePartialExits and pullbackDirection == 1 and t2ExitTriggered
exitT2Short = enablePartialExits and pullbackDirection == -1 and t2ExitTriggered
exitT3Long = enablePartialExits and pullbackDirection == 1 and t3ExitTriggered
exitT3Short = enablePartialExits and pullbackDirection == -1 and t3ExitTriggered

alertcondition(exitT1Long, title="Exit T1 - Long", 
    message="EXIT T1 LONG (" + str.tostring(t1PositionPct) + "%) on {{ticker}} {{interval}}")
alertcondition(exitT1Short, title="Exit T1 - Short",
    message="EXIT T1 SHORT (" + str.tostring(t1PositionPct) + "%) on {{ticker}} {{interval}}")
alertcondition(exitT2Long, title="Exit T2 - Long",
    message="EXIT T2 LONG (" + str.tostring(t2PositionPct) + "%) on {{ticker}} {{interval}}")
alertcondition(exitT2Short, title="Exit T2 - Short",
    message="EXIT T2 SHORT (" + str.tostring(t2PositionPct) + "%) on {{ticker}} {{interval}}")
alertcondition(exitT3Long, title="Exit T3 - Long",
    message="EXIT T3 LONG (" + str.tostring(t3PositionPct) + "%) on {{ticker}} {{interval}}")
alertcondition(exitT3Short, title="Exit T3 - Short",
    message="EXIT T3 SHORT (" + str.tostring(t3PositionPct) + "%) on {{ticker}} {{interval}}")
```

### 2.7 Testing Checklist for Batch 2

- [ ] T1 exit triggers at 1.5R or first swing
- [ ] T2 exit triggers at 2.5R or BOS swing  
- [ ] T3 trail stop updates on new swings
- [ ] Target lines display correctly
- [ ] Trail stop line follows price
- [ ] Position percentages calculate correctly (30+40+30=100)
- [ ] All 3 tiers execute in sequence
- [ ] Alerts fire for each tier
- [ ] Can be disabled (falls back to single exit)
- [ ] Works with both momentum and pullback entries

---

## BATCH 3: Dashboard Integration

### 3.1 Update Entry Row

Modify dashboard Entry row (around line 1796):

```pine
// V7.3.0: Enhanced entry status display
var string entryStatus = "-"
var color entryStatusColor = color.gray

if pullbackDirection != 0
    if t3ExitTriggered
        // All exits complete
        entryStatus := "-"
        entryStatusColor := color.gray
    else if t2ExitTriggered
        // T1 & T2 done, T3 active
        entryStatus := "T3 " + str.tostring(remainingPositionPct) + "%"
        entryStatusColor := color.orange
    else if t1ExitTriggered
        // T1 done, T2 & T3 active
        entryStatus := "T2 " + str.tostring(remainingPositionPct) + "%"
        entryStatusColor := pullbackDirection == 1 ? bullColor : bearColor
    else if entryConfirmed
        // Full position active
        if momentumEntryTaken
            entryStatus := "FULL 100%"
        else
            entryStatus := "ACTIVE " + str.tostring(remainingPositionPct) + "%"
        entryStatusColor := pullbackDirection == 1 ? bullColor : bearColor
    else if momentumEntryTaken
        // Only momentum entry
        entryStatus := "MOMENTUM " + str.tostring(momentumPositionSize) + "%"
        entryStatusColor := color.yellow
    else if pullbackConfirmed
        entryStatus := "RDY" + (pullbackDirection == 1 ? "â–²" : "â–¼")
        entryStatusColor := color.orange
    else if inGoldenZone or inDeepZone
        entryStatus := "IN" + (pullbackDirection == 1 ? "â–²" : "â–¼")
        entryStatusColor := color.lime
    else
        entryStatus := "WAIT" + (pullbackDirection == 1 ? "â–²" : "â–¼")
        entryStatusColor := color.yellow

table.cell(dashboard, 0, 5, "Entry", text_color=color.gray, text_size=size.normal)
table.cell(dashboard, 1, 5, entryStatus, text_color=entryStatusColor, text_size=size.normal)
```

---

## Implementation Timeline

### Session 1: Batch 1 (Momentum Entry)
**Estimated time:** 15-20 minutes
**Testing:** 5-10 minutes on XAG/USD 1H chart

### Session 2: Batch 2 (Partial Exits)
**Estimated time:** 25-30 minutes  
**Testing:** 10-15 minutes across multiple scenarios

### Session 3: Batch 3 (Dashboard + Polish)
**Estimated time:** 10-15 minutes
**Testing:** 5 minutes final validation

### Session 4: Documentation
**Estimated time:** 10 minutes
- Update version to V7.3.0
- Create V7.3.0_CHANGES.md
- Update CHANGELOG.md

---

## Expected Outcomes

### Performance Metrics (XAG/USD 1H)

**Without V7.3.0 (Current):**
- Entry: Pullback only (often late)
- Exit: Single target
- Avg R:R: 1.5-2.0R
- Win rate: ~55-60%

**With V7.3.0 (Target):**
- Entry: Momentum (20%) + Pullback (80%)
- Exit: T1 (30%) @ 1.5R, T2 (40%) @ 2.5R, T3 (30%) trail
- Avg R:R: 2.0-3.5R (blended across tiers)
- Win rate: ~60-65% (better entries)
- Reduced drawdown: Earlier profit taking

### Risk Management Improvements

1. **Better Entry Price:**
   - Momentum: Captures full move
   - Pullback: Gets discount price

2. **Reduced Risk Faster:**
   - T1 exit locks 0.45R profit on 30% of position
   - Allows free trade on remaining 70%

3. **Captures Extended Moves:**
   - T3 runner with trail stop
   - No manual intervention needed

---

## Notes for Implementation

1. **Test incrementally** - Don't skip testing between batches
2. **XAG/USD 1H is reference** - Adjust settings for other instruments
3. **Backup before changes** - Copy ssof.pine to ssof_v7.2.3_backup.pine
4. **Pine Script limits** - Watch for max_lines/max_labels limits
5. **Position sizing** - Ensure T1+T2+T3 = 100%

---

**Ready for implementation when you are!**

Co-Authored-By: Warp <agent@warp.dev>
